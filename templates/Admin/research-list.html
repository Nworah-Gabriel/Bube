{% load static %}
{% include 'Admin/__header.html' %}

<!-- banner -->
<div class="mil-inner-banner">
  <div class="mil-banner-content mil-up">
    <div class="mil-animation-frame">
      <div class="mil-animation mil-position-4 mil-dark mil-scale" data-value-1="6" data-value-2="1.4"></div>
    </div>
    <div class="container">
      <ul class="mil-breadcrumbs mil-mb-30">
        <li><a href="{% url 'home' %}">Admin</a></li>
        <li><a href="{% url 'research-list-admin' %}">Research</a></li>
      </ul>
      <div class="row align-items-center mil-mb-30">
        <div class="col-lg-12">
          <h1 class="mil-mb-5">Research Works</h1>
          <p class="">Manage all your research publications, articles, and papers</p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- banner end -->

<!-- research filters -->
<section class="mil-p-30-0">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="filter-tabs">
          <button class="filter-tab {% if current_status == '' %}active{% endif %}" data-status="">
            All ({{ total_count }})
          </button>
          <button class="filter-tab {% if current_status == 'published' %}active{% endif %}" data-status="published">
            Published ({{ published_count }})
          </button>
          <button class="filter-tab {% if current_status == 'draft' %}active{% endif %}" data-status="draft">
            Drafts ({{ draft_count }})
          </button>
          
        </div>
      </div>
    </div>
  </div>
</section>
<!-- research filters end -->

<!-- research list -->
<section>
  <div class="container mil-p-120-60 mil-pt-0">
    <!-- Published Research -->
    {% if published_research %}
    <div class="research-section mil-mb-30" id="published-section">
      <div class="row">
        {% for research in published_research %}
        <div class="col-lg-12 mil-mb-30">
          <div class="admin-research-card" data-id="{{ research.id }}">
            <div class="research-card-main">
              <div class="research-image">
                {% if research.thumbnail_image %}
                  <img src="{{ research.thumbnail_image }}" alt="{{ research.title }}">
                {% else %}
                  <div class="no-image">No Image</div>
                {% endif %}
                {% if research.is_featured %}
                  <span class="featured-badge">Featured</span>
                {% endif %}
              </div>
              
              <div class="research-info">
                <div class="research-header">
                  <h4 class="research-title">{{ research.title }}</h4>
                  <div class="research-meta">
                    <span class="research-type">{{ research.get_research_type_display }}</span>
                    <span class="research-date">{{ research.publication_date|date:"F d, Y" }}</span>
                    <span class="research-status status-published">Published</span>
                    {% if research.doi %}
                      <span class="research-doi" title="{{ research.doi }}">DOI: {{ research.doi|truncatechars:20 }}</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="research-content">
                  <p class="research-abstract">{{ research.abstract|truncatechars:200 }}</p>
                  
                  <div class="research-stats">
                    <span class="stat">
                      <i class="fa fa-calendar"></i> Created: {{ research.created_at|date:"M d, Y" }}
                    </span>
                    {% if research.authors %}
                      <span class="stat">
                        <i class="fa fa-users"></i> {{ research.authors|truncatechars:30 }}
                      </span>
                    {% endif %}
                  </div>
                  
                  {% if research.keywords %}
                    <div class="research-keywords">
                      {% for keyword in research.get_keywords_list|slice:":3" %}
                        <span class="keyword">{{ keyword }}</span>
                      {% endfor %}
                      {% if research.get_keywords_list|length > 3 %}
                        <span class="keyword-more">+{{ research.get_keywords_list|length|add:"-3" }} more</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="research-actions">
                <div class="action-buttons">
                  <a href="{% url 'research-edit' research.id %}" class="action-btn edit-btn" title="Edit" data-no-swup>
                    <i class="fa fa-edit"></i>
                  </a>
                  
                  <button class="action-btn status-btn {% if research.is_featured %}featured{% else %}not-featured{% endif %}" 
                          data-id="{{ research.id }}" 
                          data-featured="{{ research.is_featured|lower }}"
                          title="{% if research.is_featured %}Remove from featured{% else %}Mark as featured{% endif %}">
                    <i class="fa fa-star"></i>
                  </button>
                  
                  <button class="action-btn status-btn status-draft" 
                          data-id="{{ research.id }}" 
                          data-action="status"
                          data-status="draft"
                          title="Move to Draft">
                    <i class="fa fa-file"></i>
                  </button>
                  
                  <button class="action-btn delete-btn" 
                          data-id="{{ research.id }}"
                          data-title="{{ research.title }}"
                          title="Delete">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
                
                <div class="quick-actions">
                  <a href="{{ research.url|default:'#' }}" 
                     target="_blank" 
                     rel="noopener noreferrer"
                     class="quick-btn view-btn" data-no-swup>
                    <i class="fa fa-external-link"></i> View
                  </a>
                  {% if research.pdf_file %}
                    <a href="{{ research.pdf_file }}" 
                       target="_blank" 
                       class="quick-btn pdf-btn">
                      <i class="fa fa-file-pdf-o"></i> PDF
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Published Pagination -->
      {% if published_research.has_other_pages %}
      <div class="row">
        <div class="col-lg-12">
          <div class="mil-pagination mil-up">
            <ul class="mil-pagination-list">
              {% if published_research.has_previous %}
              <li>
                <a href="?published_page={{ published_research.previous_page_number }}&draft_page={{ draft_research.number }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
                   class="mil-pagination-prev">
                  <i class="fa fa-chevron-left"></i>
                </a>
              </li>
              {% endif %}
              
              {% for i in published_research.paginator.page_range %}
                {% if published_research.number == i %}
                  <li class="mil-active"><a href="#">{{ i }}</a></li>
                {% elif i > published_research.number|add:'-3' and i < published_research.number|add:'3' %}
                  <li>
                    <a href="?published_page={{ i }}&draft_page={{ draft_research.number }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">
                      {{ i }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
              
              {% if published_research.has_next %}
              <li>
                <a href="?published_page={{ published_research.next_page_number }}&draft_page={{ draft_research.number }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
                   class="mil-pagination-next">
                  <i class="fa fa-chevron-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Draft Research -->
    {% if draft_research %}
    <div class="research-section mil-mb-90" id="draft-section">
      <div class="row">
        {% for research in draft_research %}
        <div class="col-lg-12 mil-mb-30">
          <div class="admin-research-card draft" data-id="{{ research.id }}">
            <div class="research-card-main">
              <div class="research-image">
                {% if research.thumbnail_image %}
                  <img src="{{ research.thumbnail_image }}" alt="{{ research.title }}">
                {% else %}
                  <div class="no-image">No Image</div>
                {% endif %}
              </div>
              
              <div class="research-info">
                <div class="research-header">
                  <h4 class="research-title">{{ research.title }}</h4>
                  <div class="research-meta">
                    <span class="research-type">{{ research.get_research_type_display }}</span>
                    <span class="research-date">Created: {{ research.created_at|date:"F d, Y" }}</span>
                    <span class="research-status status-draft">Draft</span>
                  </div>
                </div>
                
                <div class="research-content">
                  <p class="research-abstract">{{ research.abstract|truncatechars:200 }}</p>
                  
                  <div class="research-stats">
                    <span class="stat">
                      <i class="fa fa-clock-o"></i> Last updated: {{ research.updated_at|date:"M d, Y" }}
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="research-actions">
                <div class="action-buttons">
                  <a href="{% url 'research-edit' research.id %}" class="action-btn edit-btn" title="Edit" data-no-swup>
                    <i class="fa fa-edit"></i>
                  </a>
                  
                  <button class="action-btn status-btn status-publish" 
                          data-id="{{ research.id }}" 
                          data-action="status"
                          data-status="published"
                          title="Publish">
                    <i class="fa fa-check"></i>
                  </button>
                  
                  <button class="action-btn delete-btn" 
                          data-id="{{ research.id }}"
                          data-title="{{ research.title }}"
                          title="Delete">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
                
                <div class="quick-actions">
                  <a href="{% url 'research-edit' research.id %}" class="quick-btn edit-full-btn" data-no-swup>
                    <i class="fa fa-pencil"></i> Continue Editing
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Draft Pagination -->
      {% if draft_research.has_other_pages %}
      <div class="row">
        <div class="col-lg-12">
          <div class="mil-pagination mil-up">
            <ul class="mil-pagination-list">
              {% if draft_research.has_previous %}
              <li>
                <a href="?published_page={{ published_research.number }}&draft_page={{ draft_research.previous_page_number }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
                   class="mil-pagination-prev" data-no-swup>
                  <i class="fa fa-chevron-left"></i>
                </a>
              </li>
              {% endif %}
              
              {% for i in draft_research.paginator.page_range %}
                {% if draft_research.number == i %}
                  <li class="mil-active"><a href="#">{{ i }}</a></li>
                {% elif i > draft_research.number|add:'-3' and i < draft_research.number|add:'3' %}
                  <li>
                    <a href="?published_page={{ published_research.number }}&draft_page={{ i }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" data-no-swup>
                      {{ i }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
              
              {% if draft_research.has_next %}
              <li>
                <a href="?published_page={{ published_research.number }}&draft_page={{ draft_research.next_page_number }}&archived_page={{ archived_research.number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
                   class="mil-pagination-next" data-no-swup>
                  <i class="fa fa-chevron-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Archived Research (Optional - if you want to show archived) -->
    {% if archived_research %}
    <div class="research-section mil-mb-90" id="archived-section">
      <div class="row">
        {% for research in archived_research %}
        <div class="col-lg-12 mil-mb-30">
          <div class="admin-research-card archived" data-id="{{ research.id }}">
            <div class="research-card-main">
              <div class="research-image">
                {% if research.thumbnail_image %}
                  <img src="{{ research.thumbnail_image }}" alt="{{ research.title }}">
                {% else %}
                  <div class="no-image">No Image</div>
                {% endif %}
              </div>
              
              <div class="research-info">
                <div class="research-header">
                  <h4 class="research-title">{{ research.title }}</h4>
                  <div class="research-meta">
                    <span class="research-type">{{ research.get_research_type_display }}</span>
                    <span class="research-date">Archived: {{ research.updated_at|date:"F d, Y" }}</span>
                    <span class="research-status status-archived">Archived</span>
                  </div>
                </div>
                
                <div class="research-content">
                  <p class="research-abstract">{{ research.abstract|truncatechars:200 }}</p>
                </div>
              </div>
              
              <div class="research-actions">
                <div class="action-buttons">
                  <button class="action-btn status-btn status-publish" 
                          data-id="{{ research.id }}" 
                          data-action="status"
                          data-status="published"
                          title="Restore">
                    <i class="fa fa-refresh"></i>
                  </button>
                  
                  <button class="action-btn delete-btn" 
                          data-id="{{ research.id }}"
                          data-title="{{ research.title }}"
                          title="Delete">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not published_research and not draft_research and not archived_research %}
    <div class="empty-state mil-mb-90">
      <div class="empty-icon">
        <i class="fa fa-file-text-o"></i>
      </div>
      <h3 class="mil-up mil-mb-30">No Research Found</h3>
      <p class="mil-light-soft mil-up mil-mb-30">You haven't created any research articles yet. Start by creating your first research publication.</p>
      <a href="{% url 'research-create' %}" class="mil-button mil-arrow-place mil-up" data-no-swup>
        <span>Create Your First Research</span>
      </a>
    </div>
    {% endif %}
  </div>
</section>
<!-- research list end -->

{% include 'Admin/__footer.html' %}

<!-- confirmation modal -->
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Confirm Action</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="modalMessage">Are you sure you want to perform this action?</p>
    </div>
    <div class="modal-footer">
      <button id="modalCancel" class="mil-button mil-outline">Cancel</button>
      <button id="modalConfirm" class="mil-button">Confirm</button>
    </div>
  </div>
</div>

<style>
  /* Tab Navigation Styles */
  .filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
  }
  
  .filter-tab {
    padding: 8px 20px;
    border: none;
    background: #f8f9fa;
    border-radius: 4px;
    color: #666;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .filter-tab:hover {
    background: #e9ecef;
  }
  
  .filter-tab.active {
    background: #4a6cf7;
    color: white;
  }
  
  /* Research Section Visibility */
  .research-section {
    display: block;
  }
  
  /* Hide sections based on active tab */
  body.all-tab-active #published-section,
  body.all-tab-active #draft-section,
  body.all-tab-active #archived-section {
    display: block;
  }
  
  body.published-tab-active #draft-section,
  body.published-tab-active #archived-section,
  body.draft-tab-active #published-section,
  body.draft-tab-active #archived-section,
  body.archived-tab-active #published-section,
  body.archived-tab-active #draft-section {
    display: none;
  }
  
  /* Admin Research Card Styles */
  .admin-research-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s;
    border-left: 4px solid #4a6cf7;
  }
  
  .admin-research-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  }
  
  .admin-research-card.draft {
    border-left-color: #ffc107;
  }
  
  .admin-research-card.archived {
    border-left-color: #6c757d;
    opacity: 0.8;
  }
  
  .research-card-main {
    display: flex;
    padding: 20px;
    gap: 20px;
  }
  
  .research-image {
    width: 120px;
    height: 100px;
    flex-shrink: 0;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  
  .research-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .no-image {
    width: 100%;
    height: 100%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 12px;
  }
  
  .featured-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #ffc107;
    color: #000;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .research-info {
    flex: 1;
  }
  
  .research-header {
    margin-bottom: 10px;
  }
  
  .research-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
    line-height: 1.3;
  }
  
  .research-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 12px;
    color: #666;
  }
  
  .research-type {
    background: #f0f0f0;
    padding: 2px 8px;
    border-radius: 12px;
  }
  
  .research-status {
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
  }
  
  .status-published {
    background: #d4edda;
    color: #155724;
  }
  
  .status-draft {
    background: #fff3cd;
    color: #856404;
  }
  
  .status-archived {
    background: #e2e3e5;
    color: #383d41;
  }
  
  .research-doi {
    color: #4a6cf7;
    font-family: monospace;
  }
  
  .research-content {
    margin-bottom: 15px;
  }
  
  .research-abstract {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
    margin-bottom: 10px;
  }
  
  .research-stats {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: #888;
    margin-bottom: 10px;
  }
  
  .stat {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .stat i {
    font-size: 11px;
  }
  
  .research-keywords {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .keyword {
    background: #f0f0f0;
    color: #666;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
  }
  
  .keyword-more {
    color: #999;
    font-size: 11px;
    font-style: italic;
  }
  
  .research-actions {
    width: 200px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .action-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 4px;
    background: #f8f9fa;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  
  .action-btn:hover {
    background: #e9ecef;
    transform: translateY(-1px);
  }
  
  .edit-btn {
    color: #4a6cf7;
  }
  
  .edit-btn:hover {
    background: #4a6cf7;
    color: white;
  }
  
  .status-btn.featured {
    color: #ffc107;
  }
  
  .status-btn.not-featured {
    color: #ddd;
  }
  
  .status-btn.status-publish {
    color: #28a745;
  }
  
  .status-btn.status-draft {
    color: #ffc107;
  }
  
  .status-btn.status-archive {
    color: #6c757d;
  }
  
  .delete-btn {
    color: #dc3545;
  }
  
  .delete-btn:hover {
    background: #dc3545;
    color: white;
  }
  
  .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .quick-btn {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    color: #666;
    text-decoration: none;
    font-size: 13px;
    text-align: center;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  .quick-btn:hover {
    background: #f8f9fa;
    color: #4a6cf7;
  }
  
  .view-btn {
    color: #4a6cf7;
    border-color: #4a6cf7;
  }
  
  .pdf-btn {
    color: #dc3545;
    border-color: #dc3545;
  }
  
  .edit-full-btn {
    color: #ffc107;
    border-color: #ffc107;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .empty-icon {
    font-size: 60px;
    color: #ddd;
    margin-bottom: 20px;
  }
  
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    overflow: hidden;
  }
  
  .modal-header {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .modal-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }
  
  .modal-body {
    padding: 30px 20px;
  }
  
  .modal-footer {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  /* Responsive */
  @media (max-width: 992px) {
    .research-card-main {
      flex-direction: column;
    }
    
    .research-image {
      width: 100%;
      height: 150px;
    }
    
    .research-actions {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
    }
    
    .quick-actions {
      flex-direction: row;
    }
  }
  
  @media (max-width: 768px) {
    .filter-tabs {
      flex-wrap: wrap;
    }
    
    .action-buttons {
      justify-content: center;
    }
    
    .research-actions {
      flex-direction: column;
    }
    
    .quick-actions {
      flex-direction: column;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tab functionality
  initTabNavigation();
  
  // Initialize action buttons
  initActionButtons();
  
  // Initialize modal
  initModal();
  
  // Tab Navigation Function
  function initTabNavigation() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const currentStatus = '{{ current_status }}' || '';
    
    // Set initial active state on body
    document.body.className = document.body.className.replace(/tab-active/g, '').trim();
    document.body.classList.add(`${currentStatus || 'all'}-tab-active`);
    
    filterTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const status = this.getAttribute('data-status');
        
        // Update active tab
        filterTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update body class for CSS filtering
        document.body.className = document.body.className.replace(/tab-active/g, '').trim();
        document.body.classList.add(`${status || 'all'}-tab-active`);
        
        // If we have a current_status from Django, use server-side filtering
        // Otherwise use client-side filtering
        if ('{{ current_status }}') {
          applyServerFilter(status);
        }
      });
    });
  }
  
  // Apply server filter (redirect with status parameter)
  function applyServerFilter(status) {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (status) {
      urlParams.set('status', status);
    } else {
      urlParams.delete('status');
    }
    
    // Reset page numbers when changing filters
    urlParams.delete('published_page');
    urlParams.delete('draft_page');
    urlParams.delete('archived_page');
    
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.location.href = newUrl;
  }
  
  // Action Buttons Functionality
  function initActionButtons() {
    // Featured toggle
    document.querySelectorAll('.status-btn[data-featured]').forEach(btn => {
      btn.addEventListener('click', function() {
        const researchId = this.getAttribute('data-id');
        const isFeatured = this.getAttribute('data-featured') === 'true';
        
        fetch('{% url "research-toggle-featured" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ id: researchId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            this.setAttribute('data-featured', data.is_featured.toString());
            this.classList.toggle('featured', data.is_featured);
            this.classList.toggle('not-featured', !data.is_featured);
            this.setAttribute('title', data.is_featured ? 'Remove from featured' : 'Mark as featured');
            
            showNotification(`Research ${data.is_featured ? 'marked as featured' : 'removed from featured'}`, 'success');
          } else {
            showNotification(data.error, 'error');
          }
        })
        .catch(error => {
          showNotification('Error updating featured status', 'error');
        });
      });
    });
    
    // Status change
    document.querySelectorAll('.status-btn[data-action="status"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const researchId = this.getAttribute('data-id');
        const newStatus = this.getAttribute('data-status');
        const researchTitle = this.closest('.admin-research-card').querySelector('.research-title').textContent;
        
        const message = newStatus === 'published' ? 
          `Publish research "${researchTitle}"?` :
          newStatus === 'draft' ?
          `Move "${researchTitle}" to drafts?` :
          `Archive research "${researchTitle}"?`;
        
        showConfirmationModal(message, () => {
          fetch('{% url "research-toggle-status" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ id: researchId, status: newStatus })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification(`Research status updated to ${newStatus}`, 'success');
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              showNotification(data.error, 'error');
            }
          })
          .catch(error => {
            showNotification('Error updating status', 'error');
          });
        });
      });
    });
    
    // Delete research
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const researchId = this.getAttribute('data-id');
        const researchTitle = this.getAttribute('data-title');
        
        showConfirmationModal(`Are you sure you want to delete "${researchTitle}"? This action cannot be undone.`, () => {
          fetch('{% url "research-delete" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ id: researchId })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification('Research deleted successfully', 'success');
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              showNotification(data.error, 'error');
            }
          })
          .catch(error => {
            showNotification('Error deleting research', 'error');
          });
        });
      });
    });
  }
  
  // Modal Functions
  function initModal() {
    const modal = document.getElementById('confirmationModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalClose = document.querySelector('.modal-close');
    
    let confirmCallback = null;
    
    window.showConfirmationModal = function(message, callback) {
      modalMessage.textContent = message;
      confirmCallback = callback;
      modal.style.display = 'flex';
    }
    
    function hideConfirmationModal() {
      modal.style.display = 'none';
      confirmCallback = null;
    }
    
    if (modalCancel) {
      modalCancel.addEventListener('click', hideConfirmationModal);
    }
    
    if (modalClose) {
      modalClose.addEventListener('click', hideConfirmationModal);
    }
    
    if (modalConfirm) {
      modalConfirm.addEventListener('click', function() {
        if (confirmCallback) {
          confirmCallback();
        }
        hideConfirmationModal();
      });
    }
    
    // Close modal on outside click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideConfirmationModal();
      }
    });
  }
  
  // Helper Functions
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: 500;
      z-index: 1001;
      animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') {
      notification.style.background = '#28a745';
    } else if (type === 'error') {
      notification.style.background = '#dc3545';
    } else if (type === 'info') {
      notification.style.background = '#4a6cf7';
    }
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
    
    // Add CSS for animations if not already present
    if (!document.getElementById('notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }
  }
});
</script>